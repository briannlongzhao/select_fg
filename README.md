# select_fg

## Description

Input the images and image segmentations generated by Entity Segmentation (split by class in subfolders), output the
foreground segment of that class and its corresponding binary mask.

## Environment
You can install by running the following:
```
conda create -n select_fg python=3.7.9
pip install -r requirements.txt
```

## Usage

The main entry point is `select_mask.py`. Run `python select_mask.py --help` for arguments.
```
usage: select_mask.py [-h] --img_root IMG_ROOT --mask_root MASK_ROOT [--save_root SAVE_ROOT] [--num_iter NUM_ITER] [--target_class TARGET_CLASS] [--dataset {coco,voc}] [--debug] [--bsz BSZ] [--M_mode {mean,gmm_tied,gmm_full}]
                      [--M_metric M_METRIC] [--M_k M_K] [--M_n_cluster M_N_CLUSTER]

optional arguments:
  -h, --help            show this help message and exit
  --img_root IMG_ROOT   root directory that contains original images of each class
  --mask_root MASK_ROOT
                        root directory that contains .npy ent seg mask of each original image of each class
  --save_root SAVE_ROOT
                        where the output is saved
  --num_iter NUM_ITER   number of iterations should F-EM run
  --target_class TARGET_CLASS
                        desired target class, must be in label2id (see metadata directory)
  --dataset {coco,voc}  which dataest F-EM is run on
  --debug               if set, only run F-EM on 10 percent of input
  --bsz BSZ             batch size used in computing feature by feature extractor
  --M_mode {mean,gmm_tied,gmm_full}
                        in M step, which algorithm should be run to determine top k percent
  --M_metric M_METRIC   in M step, which distance metric is used in selecting top k percent
  --M_k M_K             in M step, retain k percent of total images
  --M_n_cluster M_N_CLUSTER
                        only used if M_mode=gmm, if not set, try to find best n_cluster
```
The following variants are supported:

- Use mean emb
  `--M_mode mean --M_metric <any metric>`
- GMM full
  `--M_mode gmm_full --M_metric <any metric>`
- GMM tie
  `--M_mode gmm_tie --M_metric <any metric>`
 
NOTE: `M_metric` can be any metric in [scipy](https://docs.scipy.org/doc/scipy/reference/generated/scipy.spatial.distance.cdist.html#scipy.spatial.distance.cdist), including `mahalanobis`.

Also, you can use two directories in `sample_inputs` as test for `--img_root` and `--mask_root`. 

# TODO
- how to get `mask_root`?

- COCO format

- which variant is best for VOC